{% extends 'tableapp/base.html' %}
{% load custom_filters %}

{% block title %}Reporte PVO{% endblock %}

{% block content %}
<h2 class="page-title mb-2">ðŸ“Š Reporte de Pedidos Activos</h2>

<input type="hidden" id="csrf-token" value="{{ csrf_token }}">

<div class="card shadow-sm rounded">
  <div class="table-responsive" style="max-height: 75vh;">
    <table class="table table-hover table-bordered align-middle text-center">
      <thead class="sticky-top" style="background-color: #1e293b; color: #fff;">
        <tr>
          {% for col in columns %}
            {% if col == 'Fecha Pedido' %}
              <th class="text-nowrap">{{ col }}</th>
            {% elif col == 'Fecha Requerida' %}
              <th class="text-nowrap">{{ col }}</th>
              <th class="text-nowrap">FULL<br><small>(Ãºltimo insumo)</small></th>
              <th class="text-nowrap">FLP<br><small>(liberaciÃ³n planta)</small></th>
              <th class="text-nowrap">FEF<br><small>(entrega final)</small></th>
            {% elif col != 'Fecha Entrega Planta' and col != 'Fecha Estimado Fin' and col != 'Fecha FULL' and col != 'Fecha FLP' and col != 'Fecha FEF' %}
              <th class="text-nowrap">{{ col }}</th>
            {% endif %}
          {% endfor %}
          {% if perms.can_view_history %}
            <th class="text-nowrap">Acciones</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for row in registros %}
          <tr>
            {% for col in columns %}
              {% if col == 'Fecha Pedido' %}
                <td class="text-nowrap">{{ row|get_item:col }}</td>
              {% elif col == 'Fecha Requerida' %}
                <td class="text-nowrap">{{ row|get_item:col }}</td>
                
                <!-- FULL -->
                {% if perms.can_edit_full %}
                  <td
                    hx-put="{% url 'actualizar_fecha' row|get_item:'PID' 'FULL' %}"
                    hx-include="closest td"
                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                    hx-trigger="change"
                    hx-swap="none"
                  >
                    <input type="date"
                           name="fecha"
                           value="{{ row|get_item:'Fecha FULL'|date:'Y-m-d' }}"
                           class="form-control form-control-sm w-100">
                  </td>
                {% else %}
                  <td class="text-nowrap">
                    {{ row|get_item:'Fecha FULL'|default:"â€”" }}
                  </td>
                {% endif %}
                
                <!-- FLP -->
                {% if perms.can_edit_flp %}
                  <td
                    hx-put="{% url 'actualizar_fecha' row|get_item:'PID' 'FLP' %}"
                    hx-include="closest td"
                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                    hx-trigger="change"
                    hx-swap="none"
                  >
                    <input type="date"
                           name="fecha"
                           value="{{ row|get_item:'Fecha FLP'|date:'Y-m-d' }}"
                           class="form-control form-control-sm w-100">
                  </td>
                {% else %}
                  <td class="text-nowrap">
                    {{ row|get_item:'Fecha FLP'|default:"â€”" }}
                  </td>
                {% endif %}

                <!-- FEF -->
                {% if perms.can_edit_fef %}
                  <td
                    hx-put="{% url 'actualizar_fecha' row|get_item:'PID' 'FEF' %}"
                    hx-include="closest td"
                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                    hx-trigger="change"
                    hx-swap="none"
                  >
                    <input type="date"
                           name="fecha"
                           value="{{ row|get_item:'Fecha FEF'|date:'Y-m-d' }}"
                           class="form-control form-control-sm w-100">
                  </td>
                {% else %}
                  <td class="text-nowrap">
                    {{ row|get_item:'Fecha FEF'|default:"â€”" }}
                  </td>
                {% endif %}

              {% elif col != 'Fecha Entrega Planta' and col != 'Fecha Estimado Fin' and col != 'Fecha FULL' and col != 'Fecha FLP' and col != 'Fecha FEF' %}
                <td class="text-nowrap">{{ row|get_item:col }}</td>
              {% endif %}
            {% endfor %}

            {% if perms.can_view_history %}
              <td>
                <button class="btn btn-sm btn-outline-primary"
                        hx-get="{% url 'pvo_historial_modal' row|get_item:'PID' %}"
                        hx-target="#modalHistorial .modal-content"
                        hx-trigger="click"
                        data-bs-toggle="modal"
                        data-bs-target="#modalHistorial">
                  ðŸ“œ Ver histÃ³rico
                </button>
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalHistorial" tabindex="-1" aria-labelledby="modalHistorialLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <!-- AquÃ­ carga HTMX -->
    </div>
  </div>
</div>
{% endblock %}