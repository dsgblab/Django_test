{% extends 'tableapp/base.html' %}
{% load custom_filters %}

{% block title %}Reporte PVO{% endblock %}

{% block content %}
<h2 class="page-title mb-2">ðŸ“Š Reporte de Pedidos Activos</h2>
<h4>Prueba: {{ 1234567|format_miles }}</h4>

<input type="hidden" id="csrf-token" value="{{ csrf_token }}">

<div class="card shadow-sm rounded">
  <div class="table-responsive" style="max-height: 75vh;">
    <table class="table table-hover table-bordered align-middle text-center" id="tablaPVO">
      <thead class="sticky-top" style="background-color: #1e293b; color: #fff;">
        <!-- Encabezados -->
        <tr>
          {% for col in columns %}
            {% if col == 'Fecha Pedido' %}
              <th class="text-nowrap">{{ col }}</th>
            {% elif col == 'Fecha Requerida' %}
              <th class="text-nowrap">{{ col }}</th>
              <th class="text-nowrap">FULL<br><small>(Ãºltimo insumo)</small></th>
              <th class="text-nowrap">FLP<br><small>(liberaciÃ³n planta)</small></th>
              <th class="text-nowrap">FEF<br><small>(entrega final)</small></th>
            {% elif col != 'Fecha Entrega Planta' and col != 'Fecha Estimado Fin' and col != 'Fecha FULL' and col != 'Fecha FLP' and col != 'Fecha FEF' %}
              <th class="text-nowrap">{{ col }}</th>
            {% endif %}
          {% endfor %}
          {% if perms.can_view_history %}
            <th class="text-nowrap">Acciones</th>
          {% endif %}
        </tr>

        <!-- Filtros -->
        <tr>
          {% for col in columns %}
            {% if col == 'Fecha Pedido' %}
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0 }})"></th>
            {% elif col == 'Fecha Requerida' %}
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0 }})"></th>
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0|add:1 }})"></th>
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0|add:2 }})"></th>
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0|add:3 }})"></th>
            {% elif col != 'Fecha Entrega Planta' and col != 'Fecha Estimado Fin' and col != 'Fecha FULL' and col != 'Fecha FLP' and col != 'Fecha FEF' %}
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0 }})"></th>
            {% endif %}
          {% endfor %}
          {% if perms.can_view_history %}
            <th></th>
          {% endif %}
        </tr>
      </thead>

      <tbody>
        {% for row in registros %}
          <tr>
            {% for col in columns %}
              {% if col == 'Fecha Pedido' %}
                <td class="text-nowrap">{{ row|get_item:col }}</td>
              {% elif col == 'Fecha Requerida' %}
                <td class="text-nowrap">{{ row|get_item:col }}</td>

                <!-- FULL -->
                {% if perms.can_edit_full %}
                  <td hx-put="{% url 'actualizar_fecha' row|get_item:'PID' 'FULL' %}"
                      hx-include="closest td"
                      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                      hx-trigger="change"
                      hx-swap="none">
                    <input type="date"
                           name="fecha"
                           value="{{ row|get_item:'Fecha FULL'|date:'Y-m-d' }}"
                           class="form-control form-control-sm w-100">
                  </td>
                {% else %}
                  <td class="text-nowrap">{{ row|get_item:'Fecha FULL'|default:"â€”" }}</td>
                {% endif %}

                <!-- FLP -->
                {% if perms.can_edit_flp %}
                  <td hx-put="{% url 'actualizar_fecha' row|get_item:'PID' 'FLP' %}"
                      hx-include="closest td"
                      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                      hx-trigger="change"
                      hx-swap="none">
                    <input type="date"
                           name="fecha"
                           value="{{ row|get_item:'Fecha FLP'|date:'Y-m-d' }}"
                           class="form-control form-control-sm w-100">
                  </td>
                {% else %}
                  <td class="text-nowrap">{{ row|get_item:'Fecha FLP'|default:"â€”" }}</td>
                {% endif %}

                <!-- FEF -->
                {% if perms.can_edit_fef %}
                  <td hx-put="{% url 'actualizar_fecha' row|get_item:'PID' 'FEF' %}"
                      hx-include="closest td"
                      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                      hx-trigger="change"
                      hx-swap="none">
                    <input type="date"
                           name="fecha"
                           value="{{ row|get_item:'Fecha FEF'|date:'Y-m-d' }}"
                           class="form-control form-control-sm w-100">
                  </td>
                {% else %}
                  <td class="text-nowrap">{{ row|get_item:'Fecha FEF'|default:"â€”" }}</td>
                {% endif %}

              {% elif col != 'Fecha Entrega Planta' and col != 'Fecha Estimado Fin' and col != 'Fecha FULL' and col != 'Fecha FLP' and col != 'Fecha FEF' %}
                <td class="text-nowrap">
                  {% if 'valor' in col|slugify %}
                    $ {{ row|get_item:col|format_miles }}
                  {% else %}
                    {{ row|get_item:col }}
                  {% endif %}
                </td>
              {% endif %}
            {% endfor %}

            {% if perms.can_view_history %}
              <td>
                <button class="btn btn-sm btn-outline-primary"
                        hx-get="{% url 'pvo_historial_modal' row|get_item:'PID' %}"
                        hx-target="#modalHistorial .modal-content"
                        hx-trigger="click"
                        data-bs-toggle="modal"
                        data-bs-target="#modalHistorial">
                  ðŸ“œ Ver histÃ³rico
                </button>
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalHistorial" tabindex="-1" aria-labelledby="modalHistorialLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <!-- AquÃ­ carga HTMX -->
    </div>
  </div>
</div>

<!-- Filtro Script -->
<script>
function filtrarTabla(colIndex) {
  const input = event.target;
  const filtro = input.value.toLowerCase();
  const tabla = document.getElementById('tablaPVO');
  const filas = tabla.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

  for (let i = 0; i < filas.length; i++) {
    const celdas = filas[i].getElementsByTagName('td');
    const celda = celdas[colIndex];
    if (celda) {
      const texto = celda.textContent || celda.innerText;
      filas[i].style.display = texto.toLowerCase().includes(filtro) ? '' : 'none';
    }
  }
}
</script>

<!--DataTables: ordenamiento -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
  $(document).ready(function () {
    $('#tablaPVO').DataTable({
      ordering: true,
      paging: false,
      info: false,
      searching: false
    });
  });
</script>
{% endblock %}
