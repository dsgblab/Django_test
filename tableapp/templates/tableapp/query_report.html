{% extends 'tableapp/base.html' %}
{% load custom_filters %}

{% block title %}Reporte PVO{% endblock %}

{% block content %}
<h2 class="mb-4">Reporte de Pedidos Activos</h2>

<!-- CSRF token oculto para HTMX -->
<input type="hidden" id="csrf-token" value="{{ csrf_token }}">

<div class="scroll-wrapper">
  <table class="table table-bordered table-hover table-striped">
    <thead class="thead-dark">
      <tr>
        {% for col in columns %}
          {% if col == 'Fecha Pedido' %}
            <th>{{ col }}</th>

          {% elif col == 'Fecha Requerida' %}
            <th>{{ col }}</th>
            <th>Fecha de llegada de último insumo (FULL)</th>
            <th>Fecha liberación a planta (FLP)</th>
            <th>Fecha entrega final (FEF)</th>

          {% elif col != 'Fecha Entrega Planta' and col != 'Fecha Estimado Fin' and col != 'Fecha FULL' and col != 'Fecha FLP' and col != 'Fecha FEF' %}
            <th>{{ col }}</th>
          {% endif %}
        {% endfor %}
      </tr>
    </thead>

    <tbody>
      {% for row in registros %}
        <tr>
          {% for col in columns %}
            {% if col == 'Fecha Pedido' %}
              <td>{{ row|get_item:col }}</td>

            {% elif col == 'Fecha Requerida' %}
              <td>{{ row|get_item:col }}</td>

              <!-- FULL -->
              {% if perms.can_edit_full %}
                <td
                  hx-put="{% url 'actualizar_fecha' row|get_item:'PID' 'FULL' %}"
                  hx-include="closest td"
                  hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                  hx-trigger="change"
                  hx-swap="none"
                >
                  <input type="date"
                         name="fecha"
                         value="{{ row|get_item:'Fecha FULL'|date:'Y-m-d' }}"
                         class="form-control form-control-sm">
                </td>
              {% else %}
                <td>{{ row|get_item:'Fecha FULL'|date:"F j, Y" }}</td>
              {% endif %}              

              <!-- FLP -->
              {% if perms.can_edit_flp %}
                <td
                  hx-put="{% url 'actualizar_fecha' row|get_item:'PID' 'FLP' %}"
                  hx-include="closest td"
                  hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                  hx-trigger="change"
                  hx-swap="none"
                >
                  <input type="date"
                         name="fecha"
                         value="{{ row|get_item:'Fecha FLP'|date:'Y-m-d' }}"
                         class="form-control form-control-sm">
                </td>
              {% else %}
                <td>{{ row|get_item:'Fecha FLP'|date:"F j, Y" }}</td>
              {% endif %}

              <!-- FEF -->
              {% if perms.can_edit_fef %}
                <td
                  hx-put="{% url 'actualizar_fecha' row|get_item:'PID' 'FEF' %}"
                  hx-include="closest td"
                  hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                  hx-trigger="change"
                  hx-swap="none"
                >
                  <input type="date"
                         name="fecha"
                         value="{{ row|get_item:'Fecha FEF'|date:'Y-m-d' }}"
                         class="form-control form-control-sm">
                </td>
              {% else %}
                <td>{{ row|get_item:'Fecha FEF'|date:"F j, Y" }}</td>
              {% endif %}

            {% elif col != 'Fecha Entrega Planta' and col != 'Fecha Estimado Fin' and col != 'Fecha FULL' and col != 'Fecha FLP' and col != 'Fecha FEF' %}
              <td>{{ row|get_item:col }}</td>
            {% endif %}
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
